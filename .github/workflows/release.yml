name: Release

on:
  push:
    branches:
      - main

jobs:
  version:
    name: Generate next version
    runs-on: ubuntu-latest
    outputs:
      new_release_published: ${{ steps.semantic.outputs.new_release_published }}
      version: ${{ steps.semantic.outputs.new_release_version }}
      tag: ${{ steps.semantic.outputs.new_release_git_tag }}
      notes: ${{ steps.semantic.outputs.new_release_notes }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - uses: actions/setup-node@v4
        with:
          node-version: 20
      - name: Install dependencies
        run: npm ci
      - name: Run semantic-release
        id: semantic
        uses: cycjimmy/semantic-release-action@v4
        with:
          semantic_version: 24
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
  build:
    name: Build and upload artifacts
    needs: version
    if: ${{ needs.version.outputs.new_release_published == 'true' }}
    runs-on: ubuntu-latest
    outputs:
      tag: ${{ needs.version.outputs.tag}}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Checkout tag
        run: |
          git fetch --tags
          git checkout "${{ needs.version.outputs.tag}}"
      - uses: actions/setup-dotnet@v4
        with:
          dotnet-version: 10.0.x
      - name: Set build version
        env:
          VERSION: ${{ needs.version.outputs.version }}
        run: |
          python3 - << 'PY'
          import os, xml.etree.ElementTree as ET

          version = os.environ['VERSION']
          path = "VectraRuntime/VectraRuntime.csproj"

          tree = ET.parse(path)
          root = tree.getroot()

          ns = ""
          if root.tag.startswith("{"):
            ns = root.tag.split("}")[0] + "}"
          def find_or_create(parent, tag):
            el = parent.find(f"{ns}{tag}")
            if el is None:
              el = ET.SubElement(parent, f"{ns}{tag}")
            return el
          pg = root.find(f"{ns}PropertyGroup")
          if pg is None:
            pg = ET.SubElement(root, f"{ns}PropertyGroup")
          find_or_create(pg, "Version").text = version
          find_or_create(pg, "AssemblyVersion").text = version
          find_or_create(pg, "FileVersion").text = version
          find_or_create(pg, "InformationalVersion").text = version

          tree.write(path, encoding="utf-8", xml_declaration=True)
          print(f"Stamped {path} with version {version}")
          PY
      - name: Publish runtime
        run: |
          dotnet restore VectraRuntime/VectraRuntime.csproj -r win-x64
          dotnet publish VectraRuntime/VectraRuntime.csproj -c Release -r win-x64 --self-contained true --no-restore -o out/win-x64

          dotnet restore VectraRuntime/VectraRuntime.csproj -r linux-x64
          dotnet publish VectraRuntime/VectraRuntime.csproj -c Release -r linux-x64 --self-contained true --no-restore -o out/linux-x64

          (cd out && zip -r vectra-runtime-win-x64.zip win-x64)
          (cd out && zip -r vectra-runtime-linux-x64.zip linux-x64)
      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: release-artifacts
          path: |
            out/vectra-runtime-win-x64.zip
            out/vectra-runtime-linux-x64.zip
  release:
    name: Create GitHub release
    runs-on: ubuntu-latest
    needs: [version, build]
    if: ${{ needs.version.outputs.new_release_published == 'true' }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          name: release-artifacts
          path: out
      - name: Create GitHub release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh release create "${{ needs.version.outputs.tag }}" \
          out/vectra-runtime-win-x64.zip \
          out/vectra-runtime-linux-x64.zip \
          --title "${{ needs.version.outputs.tag }}" \
          --notes "${{ needs.version.outputs.notes }}"